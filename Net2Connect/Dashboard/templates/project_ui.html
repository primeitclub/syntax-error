{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Name</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Monda:wght@400..700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/project.css' %}">
</head>
<body>
  <div class="sidebar">
    <div></div><div></div><div></div><div></div><div></div>
  </div>

  <div class="main">
    <div class="header">
      <h2><b>Welcome, {{ user.first_name }}!</b></h2>
    </div>

    <div class="content">
      <div class="left-panel">
        <div class="calendar">
          <div class="calendar-top">
            <h5>Calendar</h5>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <button id="prevBtn" class="btn btn-sm btn-secondary">&lt;</button>
              <p id="calendar-month-year" style="margin: 0 10px;">Year and Month</p>
              <button id="nextBtn" class="btn btn-sm btn-secondary">&gt;</button>
            </div>
          </div>
          <div id="calendar"></div>
        </div>

        <div class="project-directory">
          <div class="progress-area" style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem; font-size: 14px; color: #555;">
              <span id="progress-text">0 / 0 tasks completed</span>
            </div>
            <div style="background-color: #e0e0e0; border-radius: 8px; height: 8px; overflow: hidden;">
              <div id="progress-bar" style="background-color: #4caf50; width: 0%; height: 100%; transition: width 0.3s;"></div>
            </div>

            <!-- Celebration GIF -->
            <div id="clap-gif-container" style="width:100%; margin-top:1rem; display:none; text-align:center;">
              <img src="{% static 'images/clap.gif' %}" alt="Clapping!" style="width: 150px;">
            </div>
          </div>
        </div>

      </div>

      <div class="right-panel">
        <div class="urgent-tasks">
          <h5>Tasks</h5>
          <ul id="taskList" style="list-style: none; padding: 0;">
            {% for task in tasks %}
              <li>{{ task }}</li>
            {% empty %}
              <li>No tasks yet.</li>
            {% endfor %}
          </ul>
          <button id="addTaskBtn">Add Task</button>
        </div>

        <div class="cmts-and-team">
          <div class="comments">
  <h5>Comments</h5>
  <ul id="commentList" style="list-style: none; padding: 0; margin-bottom: 1rem;">
    {% for comment in comments %}
      <li style="margin-bottom: 0.5rem;">
        <b>{{ comment.user }}</b>: {{ comment.text }}
      </li>
    {% empty %}
      <li>No comments yet.</li>
    {% endfor %}
  </ul>

  <div style="display: flex; gap: 0.5rem;">
    <input id="commentInput" type="text" placeholder="Write a comment..." style="flex: 1; padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc;">
    <button id="addCommentBtn" class="btn btn-primary btn-sm">Add</button>
  </div>
</div>

          <div class="team-directory">
            <h5>Team Members</h5>
            <ul style="list-style: none; padding: 0;">
              {% for member in team_members %}
                <li>{{ member }}</li>
              {% empty %}
                <li>No team members yet.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const calendar = document.getElementById('calendar');
    const monthYearText = document.getElementById('calendar-month-year');
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth();

    function renderCalendar(year, month) {
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      monthYearText.innerText = `${monthNames[month]} ${year}`;

      let html = '<table><tr>';
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      days.forEach(d => html += `<th>${d}</th>`);
      html += '</tr><tr>';

      for (let i = 0; i < firstDay; i++) html += '<td></td>';

      for (let date = 1; date <= lastDate; date++) {
        const currentDate = new Date(year, month, date);
        let classes = '';
        const isToday = currentDate.toDateString() === today.toDateString();
        const isSaturday = currentDate.getDay() === 6;
        if (isToday) classes = 'today';
        else if (isSaturday) classes = 'holiday';
        html += `<td class="${classes}">${date}</td>`;
        if ((date + firstDay) % 7 === 0) html += '</tr><tr>';
      }

      html += '</tr></table>';
      calendar.innerHTML = html;
    }

    renderCalendar(currentYear, currentMonth);
    document.getElementById('prevBtn').addEventListener('click', () => {
      currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar(currentYear, currentMonth);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar(currentYear, currentMonth);
    });

    const addTaskBtn = document.getElementById('addTaskBtn');
    const taskList = document.getElementById('taskList');
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const clapGifContainer = document.getElementById('clap-gif-container');

    function updateProgress() {
      const tasks = taskList.querySelectorAll('li');
      if (tasks.length === 0 || (tasks.length === 1 && tasks[0].textContent === 'No tasks yet.')) {
        progressText.textContent = `0 / 0 tasks completed`;
        progressBar.style.width = '0%';
        clapGifContainer.style.display = 'none';
        return;
      }
      const totalTasks = tasks.length;
      let completedTasks = 0;
      tasks.forEach(task => {
        const checkbox = task.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) completedTasks++;
      });
      progressText.textContent = `${completedTasks} / ${totalTasks} tasks completed`;
      const percent = totalTasks === 0 ? 0 : (completedTasks / totalTasks) * 100;
      progressBar.style.width = `${percent}%`;
      if (percent === 100) clapGifContainer.style.display = 'block';
      else clapGifContainer.style.display = 'none';
    }

    function attachCheckboxListener(checkbox) {
      checkbox.addEventListener('change', updateProgress);
    }

    addTaskBtn.addEventListener('click', () => {
      if (document.getElementById('newTaskInput')) return;

      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'newTaskInput';
      input.placeholder = 'Type new task and press Enter';
      Object.assign(input.style, {
        width: '100%', padding: '0.4rem 0.6rem', border: 'none', outline: 'none',
        backgroundColor: '#f5f5f5', borderRadius: '8px', fontSize: '14px', boxSizing: 'border-box'
      });
      taskList.after(input);
      input.focus();

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim() !== '') {
          const noTaskItem = taskList.querySelector('li');
          if (noTaskItem && noTaskItem.textContent.trim() === 'No tasks yet.') noTaskItem.remove();

          const li = document.createElement('li');
          li.style.display = 'flex'; li.style.alignItems = 'center'; li.style.justifyContent = 'space-between'; li.style.gap = '0.5rem';

          const leftDiv = document.createElement('div');
          leftDiv.style.display = 'flex'; leftDiv.style.alignItems = 'center'; leftDiv.style.gap = '0.5rem';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          attachCheckboxListener(checkbox);

          const label = document.createElement('span');
          label.textContent = input.value.trim();
          leftDiv.appendChild(checkbox);
          leftDiv.appendChild(label);

          const deleteBtn = document.createElement('button');
          Object.assign(deleteBtn.style, { background: 'none', border: 'none', cursor: 'pointer', padding: '0', marginLeft: 'auto' });
          deleteBtn.title = 'Delete task';
          deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="#e74c3c" viewBox="0 0 24 24" width="20" height="20">
              <path d="M3 6h18v2H3V6zm2 3h14v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V9zm3 2v7h2v-7H8zm4 0v7h2v-7h-2zM9 4h6v2H9V4z"/></svg>`;
          deleteBtn.addEventListener('click', () => {
            li.remove();
            if (taskList.children.length === 0) {
              const noTasks = document.createElement('li');
              noTasks.textContent = 'No tasks yet.';
              taskList.appendChild(noTasks);
            }
            updateProgress();
          });

          li.appendChild(leftDiv);
          li.appendChild(deleteBtn);
          taskList.appendChild(li);
          updateProgress();
          input.value = '';
          input.remove();
          addTaskBtn.focus();
        } else if (e.key === 'Escape') {
          input.remove();
          addTaskBtn.focus();
        }
      });

      input.addEventListener('blur', () => { input.remove(); });
    });

    document.querySelectorAll('#taskList input[type="checkbox"]').forEach(cb => { attachCheckboxListener(cb); });
    updateProgress();

    const commentList = document.getElementById('commentList');
const commentInput = document.getElementById('commentInput');
const addCommentBtn = document.getElementById('addCommentBtn');

// we get username from Django context:
const currentUser = "{{ user.first_name }}";

addCommentBtn.addEventListener('click', () => {
  const text = commentInput.value.trim();
  if (text === '') return;

  // Remove "No comments yet."
  const noComments = commentList.querySelector('li');
  if (noComments && noComments.textContent.trim() === 'No comments yet.') {
    noComments.remove();
  }

  const li = document.createElement('li');
  li.style.marginBottom = '0.5rem';
  li.innerHTML = `<b>${currentUser}</b>: ${text}`;

  commentList.appendChild(li);

  commentInput.value = '';
  commentInput.focus();
});

  </script>
</body>
</html>
